---
title: 计算机网络-数据链路层
date: {{ date }}
tags: Internet
categories:
comments: true
---


### 基本问题

#### 1. 封装成帧

将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。
![image](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/29a14735-e154-4f60-9a04-c9628e5d09f4.png)

#### 2. 透明传输

透明表示一个实际存在的事物看起来好像不存在一样。

帧使用首部和尾部进行定界，如果帧的数据部分含有和首尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。因此需要在数据部分出现首尾部相同的内容前面插入转义字符。如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

![image](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e738a3d2-f42e-4755-ae13-ca23497e7a97.png)

#### 3. 差错检测

目前数据链路层广泛使用来循环冗余校验（CRC）来检查比特差错。


### 信道分类

- 点对点信道：一对一通信，因为不会发生碰撞，因此也比较简单，使用PPP协议进行控制。
- 广播信道：一对多通信，一个节点发送的数据能够倍广播信道上所有的节点接收到。
    - 所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。
    - 主要有两种控制方法进行协调，一个是信道复用技术，另一个是CSMA/CD协议。


#### 点对点信道的相关概念

- 链路：从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有任何其他的交换结点。
- 数据链路：当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成来数据链路。
    - 现在最常用的方法是使用网络适配器来实现这些协议。


### PPP协议

PPP（Point to Point Protocol）点对点协议

互联网用户通常需要连接到某个ISP之后才能接入到互联网，PPP协议是用户计算机和ISP进行通信时所使用的数据链路层协议。
![image](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e1ab9f28-cb15-4178-84b2-98aad87f9bc8.jpg)

PPP的帧格式：
- F 字段为帧的定界符 1字节
- A 和 C 字段暂时没有意义 1字节
- FCS 字段是使用CRC的检验序列 2字节
- 信息部分的长度不超过1500字节
- 协议字段：信息字段  2字节
    - 0x0021 ： IP数据报
    - 0xC021 ： 链路控制协议LCP的数据
    - 0x8021 ： 网络层的控制数据


![image](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/759013d7-61d8-4509-897a-d75af598a236.png)

#### CRC校验手动计算示例

生成多项式:G(x)=x^4+x^3+1，要求出二进制序列10110011的CRC校验码。

- 1. G(x)=x^4+x^3+1,二进制比特串为11001;(有X的几次方，对应的2的几次方的位就是1)
- 2. 因为校验码4位，所以10110011后面再加4个0，得到101100110000，用“模2除法”(其实就是亦或^)即可得出结果；
- 3. CRC^101100110000得到101100110100。发送到接收端；
- 4. 接收端收到101100110100后除以11001(以“模2除法”方式去除),余数为0则无差错；

![image](https://ae01.alicdn.com/kf/HTB1XMQkdG1s3KVjSZFAq6x_ZXXaw.jpg)

#### 字节填充、零比特填充

- 字节填充：在发送端，当发现信息字段中出现与定界符相同的字符时，插入转义符，当信息字段中出现转义符时，在转义符前插入转义符。
- 零比特填充：在发送端，扫描整个信息字段，只要发现有5个连续的1，则立即填入一个0，确保信息字段不会出现6个连续1.

### CSMA/CD协议

CSMA/CD（Carrier Sense Multiple Access with Collision Detection） 表示载波监听多点接入/碰撞检测

- 多点接入：说明这是总线型网络，许多主机以多点的方式连接到总线上
- 载波监听：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
- 碰撞检测：在发送中，如果检测到信道已有其他主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。

> 总结：先听后发、边听边发、冲突停发、随机重发。    
显然使用CSMA/CD协议，不可能同时进行发送和接收（但必须边发送边监听信道），因此使用CSMA/CD协议的以太网只能进行半双工通信。

记端到端的传播时延为τ，最先发送的站点最多经过2τ就可以知道是否发生了碰撞，称2τ为**争用期**。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用**截断二进制指数退避算法**来确定。从离散的整数集合{0，1，...，(2^k-1)}中随机取出一个数，记作r，然后取r倍的争用期作为重传等待时间。

整数集合中的参数k按下面的公式计算：k = Min[重传次数, 10]

当重传16次仍不能成功时，表明网络堵塞，则丢弃该帧，并向高层报告。

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/19d423e9-74f7-4c2b-9b97-55890e0d5193.png)

### MAC地址

MAC地址是链路层地址，长度为6字节（48位），用于唯一标识网络适配器（网卡）。

一台主机拥有多少个网络适配器就有多少个MAC地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个MAC地址。

### 局域网

局域网是一种典型的广播信道。  

#### 局域网的特点：  

- 网络为一个单位所拥有，且地理范围和站点数目均有限。
- 具有广播功能，局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
- 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变。
- 提高了系统的可靠性、可用性和生存性。

#### 局域网的分类：
可按照网络拓扑进行分类：

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/807f4258-dba8-4c54-9c3c-a707c7ccffa2.jpg)

### 以太网

以太网是一种星型拓扑结构局域网。

#### 以太网的两个标准

1. DEC公司、Intel公司、Xerox公司联合提出的DIX Ethernet V2标准，数据率10Mbit/s，使用曼彻斯特编码。
2. IEEE 802委员会提出的IEEE 802.3标准，数据率：10Mbit/s，使用差分曼彻斯特编码。

IEEE 802委员会把局域网的数据链路层拆分成了**逻辑链路控制LLC**、**媒体接入控制MAC**两个子层。  
因为TCP/IP协议经常使用的局域网协议是DIX Ethernet V2标准，因此802.3的LLC的作用已经消失了，之后厂商生产的适配器就仅装有MAC协议而没有LLC协议。


#### 以太网帧格式：

- 类型：标记上层使用的协议；
- 数据：长度在46-1500之间，如果太小则需要填充；
- FCS：帧检验序列，使用的是CRC检验方法；

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/164944d3-bbd2-4bb2-924b-e62199c51b90.png)

### 交换机Switch

交换机具有自学习能力，学习的是交换表的内容，交换表中存储这MAC地址到接口的映射。

正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有4个接口，主机A向主机B发送数据帧时，交换机把主机A到接口1的映射写入交换表中。为了发送数据帧到B，先查交换表，此时没有主机B的表项，那么主机A就发送广播帧，主机C和主机D会丢弃该帧，主机B回应该帧向主机A发送数据包时，交换机查找交换表得到主机A映射的接口为1，就发送数据帧到接口1，同时交换机添加主机B到接口2的映射。

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/a4444545-0d68-4015-9a3d-19209dc436b3.png)

### 虚拟局域网VLAN

虚拟局域网只是给局域网用户提供的一种服务，而不是一种新型局域网。

虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。

例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

使用 VLAN 干线连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连 VLAN 交换机。IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了 4 字节首部 VLAN 标签，用于表示该帧属于哪一个虚拟局域网。

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e98e9d20-206b-4533-bacf-3448d0096f38.png)
